<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Employee Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; }
    .dashboard-container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 250px; background: linear-gradient(to bottom, #001f3f, #0074D9); color: #fff;
      padding: 30px 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar h2 { font-size: 24px; margin-bottom: 30px; color: #7FDBFF; }
    .sidebar ul { list-style: none; }
    .sidebar ul li { margin: 20px 0; }
    .sidebar ul li a { text-decoration: none; color: #ccefff; font-size: 16px; transition: all 0.3s ease; }
    .sidebar ul li a:hover { color: #ffffff; padding-left: 8px; }

    /* Main Content */
    .main-content { flex: 1; padding: 30px; background-color: #ffffff; display: flex; flex-direction: column; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; }
    .topbar h1 { font-size: 26px; color: #333; margin-bottom: 10px; }
    .logout-btn {
      background: linear-gradient(45deg, #ff4b2b, #ff416c); color: white;
      padding: 10px 18px; border: none; border-radius: 6px;
      font-size: 14px; cursor: pointer; transition: 0.3s ease;
    }
    .logout-btn:hover { background: linear-gradient(45deg, #e63e2e, #e03362); }

    /* Dashboard Flex */
    .dashboard-flex { display: flex; gap: 25px; align-items: flex-start; flex-wrap: wrap; }

    /* Attendance Panel */
    .attendance-panel {
      flex: 0.8; padding: 20px; background: #ffffff;
      color: #333; border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; gap: 8px;
      min-width: 250px; max-width: 300px;
      align-items: center;
    }

    .attendance-profile { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin-bottom: 15px; border: 2px solid #0074D9; }
    .attendance-profile img { width: 100%; height: 100%; object-fit: cover; }

    .attendance-panel p, .attendance-panel h2 {
      text-align: left;
      width: 100%;
      margin: 5px 0;
    }

    /* Attendance Buttons */
    .attendance-btn {
      margin-top: 10px;
      padding: 12px 0;
      font-size: 16px;
      width: 120px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s ease;
    }

    #checkin-btn { background: #ff4b2b; color: white; }
    #checkin-btn:disabled { background: white; color: #ff4b2b; border: 1px solid #ff4b2b; }

    #checkout-btn { background: #27ae60; color: white; }
    #checkout-btn:disabled { background: white; color: #27ae60; border: 1px solid #27ae60; }

    /* Cards */
    .cards-container {
      flex: 2;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .card {
      padding: 25px;
      border-radius: 14px;
      color: white;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    .card:hover { transform: translateY(-5px); }
    .card:nth-child(1) { background: linear-gradient(to right, #43cea2, #185a9d); }
    .card:nth-child(2) { background: linear-gradient(to right, #f7971e, #ffd200); }
    .card:nth-child(3) { background: linear-gradient(to right, #ff512f, #dd2476); }
    .card h2 { font-size: 24px; margin-bottom: 10px; }

    /* Calendar Section */
    #announcement-details-section, #attendance-calendar-section {
      display:none; margin-top:20px; width:100%; padding:20px;
      border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);
      background-color:#fff; position:relative;
    }

    #announcement-details-section h2, #attendance-calendar-section h2{ text-align: center; margin-bottom: 20px; color: #333; }
    #calendar, #attendanceCalendar {
      margin: 20px auto; width: 100% !important; min-height: 600px !important;
    }
    .back-btn {
      position: absolute; top: 15px; left: 15px;
      background: #185a9d; color: white; border: none;
      border-radius: 50%; width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }
    .back-btn:hover { background: #43cea2; }

    #attendance-detail-section {
      display: none;
      margin-top: 20px;
      padding: 25px;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transition: all 0.3s ease-in-out;
    }

    #attendance-detail-section h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 8px;
    }
    .horizontal-attendance {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .date-column {
      min-width: 120px;
      text-align: center;
      margin-right: 20px;
    }

    .date-text {
      font-weight: bold;
      font-size: 16px;
      color: #185a9d;
    }

    .day-text {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    .timeline-bar {
      position: relative;
      flex-grow: 1;
      height: 6px;
      background-color: #d0d0d0;
      border-radius: 4px;
      margin: 0 20px;
    }

    .start-time,
    .end-time {
      position: absolute;
      top: -20px;
      font-size: 13px;
      font-weight: bold;
      color: #333;
    }

    .start-time {
      left: 0;
    }

    .end-time {
      right: 0;
    }

    .worked-hours {
      min-width: 120px;
      text-align: right;
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }

    .attendance-status {
      margin-top: 15px;
      text-align: right;
      font-size: 14px;
      font-weight: bold;
      color: #444;
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      color: white;
      margin-left: 6px;
    }

    .status-pill.Present {
      background-color: #27ae60;
    }

    .status-pill.Absent {
      background-color: #e74c3c;
    }

    .status-pill.Leave {
      background-color: #f39c12;
    }

    .status-pill.Weekend,
    .status-pill.Holiday {
      background-color: #7f8c8d;
    }

    /* Horizontal Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-top: 20px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #333;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    #timer { font-size: 24px; font-weight: bold; margin-top: 10px; }

    /* Loader */
    #loader-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.3s;
    }
    #loader-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #0074D9; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    /* New styles for the no-data message */
    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 18px;
    }
  </style>
</head>
<body>

<div id="loader-overlay" class="hidden"><div class="spinner"></div></div>

<div class="dashboard-container">
  <div class="sidebar">
    <h2>Employee Panel</h2>
    <ul>
      <li><a th:href="@{/dashboard}" class="active">Dashboard</a></li>
      <li><a th:href="@{/profile}">Profile</a></li>
      <li><a href="#">Tasks</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="topbar">
      <h1>Welcome, <span th:text="${user.fullName}">Employee</span></h1>
      <form id="logoutForm" action="/logout" method="post" style="display:inline;">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="logout-btn">Logout</button>
      </form>
    </div>

    <div class="dashboard-flex">
      <div class="attendance-panel">
        <div class="attendance-profile" style="text-align:center; margin-bottom:10px;">
          <img th:src="${user.profilePicPath != null} ? @{/uploads/{file}(file=${user.profilePicPath})} : @{/images/default-user.png}" alt="">
        </div>

        <h2>Today's Attendance</h2>
        <p><strong>Name:</strong> <span th:text="${user.fullName}">Employee Name</span></p>
        <p><strong>Department:</strong> <span th:text="${user.department.name}">Department Name</span></p>
        <div id="timer">00:00:00</div>
        <div style="display:flex; gap:10px;">
          <button id="checkin-btn" class="attendance-btn">Check In</button>
          <button id="checkout-btn" class="attendance-btn" disabled>Check Out</button>
        </div>
      </div>

      <div class="cards-container" id="dashboard-section">
        <div class="card" id="attendance-calendar-card"><h2>Attendance</h2></div>
        <div class="card"><h2>Leaves</h2></div>
        <div class="card" id="total-announcements-card"><h2>Announcements</h2></div>
      </div>
    </div>

    <div id="announcement-details-section">
      <button class="back-btn" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i></button>
      <h2>Announcements Calendar</h2>
      <div id="calendar"></div>
    </div>

    <div id="attendance-calendar-section">
      <button class="back-btn" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i></button>
      <h2>My Attendance Calendar</h2>

      <div id="attendance-calendar-content">
        <div id="attendanceCalendar"></div>
        <div class="legend">
          <div class="legend-item"><span class="legend-color" style="background: green;"></span> Present</div>
          <div class="legend-item"><span class="legend-color" style="background: red;"></span> Absent</div>
          <div class="legend-item"><span class="legend-color" style="background: yellow;"></span> Leave</div>
        </div>
      </div>

      <div id="no-attendance-data-message" class="no-data-message" style="display: none;">
        No attendance data found for this period.
      </div>

      <div id="attendance-detail-section">
        <button class="back-btn" onclick="hideAttendanceDetails()"><i class="fas fa-arrow-left"></i></button>
        <h3 id="attendance-detail-title">Attendance Details</h3>

        <div class="horizontal-attendance">
          <div class="date-column">
            <div id="detail-date" class="date-text">--</div>
            <div id="detail-day" class="day-text">--</div>
          </div>

          <div class="timeline-bar">
            <div class="start-time" id="detail-checkin">--</div>
            <div class="end-time" id="detail-checkout">--</div>
          </div>

          <div class="worked-hours">
            <span id="detail-hours">0</span> Hrs Worked
          </div>
        </div>

        <div class="attendance-status">
          Status: <span id="detail-status" class="status-pill">--</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
  function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
  function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

  // This function navigates from any sub-section back to the main dashboard.
  function backToDashboard() {
    document.getElementById('announcement-details-section').style.display = 'none';
    document.getElementById('attendance-calendar-section').style.display = 'none';
    document.querySelector('.attendance-panel').style.display = 'flex';
    document.getElementById('dashboard-section').style.display = 'grid';
  }

  // This function navigates from the attendance details back to the attendance calendar.
  function hideAttendanceDetails() {
    document.getElementById('attendance-detail-section').style.display = 'none';
    document.getElementById('attendance-calendar-content').style.display = 'block';

    if (attendanceCalendarInstance) {
        attendanceCalendarInstance.render();
    }
  }

  // ---------------- Announcements ----------------
  document.getElementById('total-announcements-card').addEventListener('click', function(event) {
    event.preventDefault();
    showLoader();
    fetch('/announcements')
      .then(res => res.json())
      .then(data => {
        document.querySelector('.attendance-panel').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('announcement-details-section').style.display = 'block';
        let calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = "";
        let calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 600,
          events: data.map(a => ({
            title: a.title,
            start: a.createdAt,
            description: a.content
          }))
        });
        calendar.render();
        hideLoader();
      })
      .catch(err => { alert("Error loading announcements."); console.error(err); hideLoader(); });
  });

  // ---------------- Attendance Timer + Buttons ----------------
   let checkinTime = null, timerInterval = null;
  const checkinBtn = document.getElementById('checkin-btn');
  const checkoutBtn = document.getElementById('checkout-btn');
  const timerDisplay = document.getElementById('timer');

  function formatTime(seconds) {
    const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${secs}`;
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - checkinTime) / 1000);
      timerDisplay.textContent = formatTime(diff);
      if (diff === 8 * 3600) alert("8 hours complete! You can check out now.");
    }, 1000);
  }

  // Restore checkin from localStorage
  window.addEventListener("load", () => {
    const storedCheckin = localStorage.getItem("checkinTime");
    const checkedOut = localStorage.getItem("checkedOut");

    if (storedCheckin && !checkedOut) {
      checkinTime = new Date(storedCheckin);
      checkinBtn.disabled = true;
      checkoutBtn.disabled = false;
      startTimer();
    } else {
      timerDisplay.textContent = "00:00:00";
      checkinBtn.disabled = false;
      checkoutBtn.disabled = true;
    }
  });

  checkinBtn.addEventListener('click', () => {
    checkinTime = new Date();
    localStorage.setItem("checkinTime", checkinTime.toISOString());
    localStorage.removeItem("checkedOut"); // Ensure checkedOut is removed on check-in

    checkinBtn.disabled = true;
    checkoutBtn.disabled = false;
    startTimer();

    fetch('/attendance/checkin', { method: 'POST' }).catch(err => console.error(err));
  });

  checkoutBtn.addEventListener('click', () => {
    clearInterval(timerInterval);
    const workedSeconds = Math.floor((new Date() - checkinTime) / 1000);
    timerDisplay.textContent = formatTime(workedSeconds);

    checkoutBtn.disabled = true;
    localStorage.setItem("checkedOut", "true"); // Mark as checked out

    fetch('/attendance/checkout', { method: 'POST' }).catch(err => console.error(err));
  });

  function scheduleMidnightReset() {
    const now = new Date();
    const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
    const msUntilMidnight = midnight.getTime() - now.getTime();

    setTimeout(() => {
      timerDisplay.textContent = "00:00:00";
      checkinBtn.disabled = false;
      checkoutBtn.disabled = true;
      checkinTime = null;
      clearInterval(timerInterval); // Clear interval to prevent multiple timers
      timerInterval = null;
      localStorage.removeItem("checkinTime");
      localStorage.removeItem("checkedOut");
      scheduleMidnightReset(); // Reschedule for the next midnight
    }, msUntilMidnight);
  }
  scheduleMidnightReset();

  let attendanceCalendarInstance = null;

  // Attendance Calendar card click
  document.getElementById('attendance-calendar-card').addEventListener('click', function(event) {
    event.preventDefault();
    showLoader();

    fetch('/attendance/calendar')
      .then(res => res.json())
      .then(data => {
        // Hide the dashboard sections and show the attendance calendar section
        document.querySelector('.attendance-panel').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('attendance-calendar-section').style.display = 'block';

        // Hide the details section in case it was open
        document.getElementById('attendance-detail-section').style.display = 'none';

        // Check if data is empty or not an array
        if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('attendance-calendar-content').style.display = 'none';
            document.getElementById('no-attendance-data-message').style.display = 'block';
        } else {
            document.getElementById('attendance-calendar-content').style.display = 'block';
            document.getElementById('no-attendance-data-message').style.display = 'none';

            let calendarEl = document.getElementById('attendanceCalendar');
            if(attendanceCalendarInstance) {
                attendanceCalendarInstance.destroy();
                attendanceCalendarInstance = null;
            }

            attendanceCalendarInstance = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              height: 600,
              events: data.map(a => ({
                start: a.date,
                display: 'background',
                backgroundColor: a.status === "Present" ? "green" :
                                 a.status === "Absent" ? "red" : "yellow"
              })),
              eventDidMount: function(info) {
                info.el.style.borderRadius = "8px";
              },
              dateClick: function(info) {
                const selectedDate = info.dateStr;
                showLoader();
                fetch(`/api/attendance/day/${selectedDate}`)
                  .then(res => res.json())
                  .then(data => {
                    document.getElementById('attendance-calendar-content').style.display = 'none';
                    document.getElementById('attendance-detail-section').style.display = 'block';

                    const dateObj = new Date(selectedDate);
                    const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });

                    document.getElementById('detail-date').innerText = selectedDate;
                    document.getElementById('detail-day').innerText = dayName;
                    const statusEl = document.getElementById('detail-status');

                    if (dayName === "Saturday" || dayName === "Sunday") {
                      statusEl.innerText = "Weekend";
                      statusEl.className = "status-pill Weekend";
                      document.getElementById('detail-checkin').innerText = "-";
                      document.getElementById('detail-checkout').innerText = "-";
                      document.getElementById('detail-hours').innerText = "0";
                    } else {
                      function formatHHMM(timeStr) {
                        if (!timeStr) return "-";
                        if (timeStr.includes(":")) {
                          const parts = timeStr.split(":");
                          return parts[0].padStart(2,"0") + ":" + parts[1].padStart(2,"0");
                        }
                        const d = new Date(timeStr);
                        if (!isNaN(d)) return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
                        return "-";
                      }

                      const checkIn = formatHHMM(data.checkInTime);
                      const checkOut = formatHHMM(data.checkOutTime);
                      const hoursWorked = data.hoursWorked || "0";

                      document.getElementById('detail-checkin').innerText = checkIn;
                      document.getElementById('detail-checkout').innerText = checkOut;
                      document.getElementById('detail-hours').innerText = hoursWorked;
                      const status = data.status || "Absent";
                      statusEl.innerText = status;
                      statusEl.className = "status-pill " + status;
                    }
                    hideLoader();
                  })
                  .catch(err => {
                    console.error("Error fetching attendance data", err);
                    hideLoader();
                  });
              }
            });
            attendanceCalendarInstance.render();
        }
        hideLoader();
      })
      .catch(err => { alert("Error loading attendance."); console.error(err); hideLoader(); });
  });

  window.addEventListener('DOMContentLoaded', hideLoader);
</script>

</body>
</html>