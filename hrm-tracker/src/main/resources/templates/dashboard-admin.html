<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style1.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>

</head>
<body>
<div id="loader-overlay" class="hidden">
    <div class="spinner"></div>
</div>

<div class="dashboard-container">
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <ul>
            <li><a href="#" onclick="showSection('dashboard-section')">Dashboard</a></li>
            <li><a th:href="@{/admin/audit-logs}">Audit Logs</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h1>Welcome, <span th:text="${user.fullName}">Admin</span></h1>
            <div>
                <form id="logoutForm" action="/logout" method="post" style="display:inline;">
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>

        <div class="cards-container" id="dashboard-section">
            <div class="card" id="total-employees-card">
                <h2>Employees</h2>
            </div>
            <div class="card" id="total-departments-card" style="cursor:pointer;">
                <h2>Departments</h2>
            </div>
            <div class="card" id="total-hrs-card" title="Click to view all HRs" style="cursor:pointer;">
                <h2>HRs</h2>
            </div>
            <div class="card">
                <h2>Leaves</h2>
            </div>
            <div class="card" id="attendance-card">
                <h2>Attendance</h2>
            </div>
            <div class="card" id="total-announcements-card"><h2>Announcements</h2></div>
        </div>

        <div id="attendance-user-list-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')"><i class="fas fa-arrow-left"></i></button>
            <h2>Attendance Dashboard</h2>
            <table id="attendance-users-table" border="1" cellpadding="10" cellspacing="0">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Email</th>
                    <th>Role</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="user-attendance-calendar-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')"><i class="fas fa-arrow-left"></i></button>
            <h2 id="user-attendance-title"></h2>

            <div id="attendance-calendar-content">
                <div id="userAttendanceCalendar"></div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color" style="background: green;"></span> Present</div>
                    <div class="legend-item"><span class="legend-color" style="background: red;"></span> Absent</div>
                    <div class="legend-item"><span class="legend-color" style="background: yellow;"></span> Leave</div>
                </div>
            </div>

            <div id="no-attendance-data-message" class="no-data-message" style="display: none;">
                No attendance data found for this period.
            </div>

            <div id="attendance-detail-section" style="display: none;">
                <button class="back-btn" onclick="hideAttendanceDetails()"><i class="fas fa-arrow-left"></i></button>
                <h3 id="attendance-detail-title">Attendance Details</h3>

                <div class="horizontal-attendance">
                    <div class="date-column">
                        <div id="detail-date" class="date-text">--</div>
                        <div id="detail-day" class="day-text">--</div>
                    </div>
                    <div class="timeline-bar">
                        <div class="start-time" id="detail-checkin">--</div>
                        <div class="end-time" id="detail-checkout">--</div>
                    </div>
                    <div class="worked-hours">
                        <span id="detail-hours">0</span>
                    </div>
                </div>
                <div class="attendance-status">
                    Status: <span id="detail-status" class="status-pill">--</span>
                </div>
            </div>
        </div>

        <div id="employee-details-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')"><i class="fas fa-arrow-left"></i></button>
            <h2>Employees List</h2>
            <table id="employees-table" border="1" cellpadding="10" cellspacing="0">
                <thead>
                <tr>
                    <th>Name</th><th>Email</th><th>Phone</th><th>Department</th><th>Auth Provider</th>
                    <th>ID Proof</th><th>Resume</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="department-details-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')"><i class="fas fa-arrow-left"></i></button>
            <h2>Departments List</h2>

            <form id="department-add-form">
                <input type="text" id="dept-name" placeholder="Department Name" required>
                <input type="text" id="dept-desc" placeholder="Description" required>
                <button type="submit">Add Department</button>
            </form>

            <table id="departments-table" border="1" cellpadding="10" cellspacing="0">
                <thead>
                <tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="hr-details-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')"><i class="fas fa-arrow-left"></i></button>
            <h2>HR List</h2>
            <table id="hr-table">
                <thead>
                <tr>
                    <th>Name</th><th>Email</th><th>Phone</th><th>Department</th><th>Role</th>
                    <th>ID Proof</th><th>Resume</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="announcement-details-section" style="display:none;">
            <button class="back-btn" onclick="showSection('dashboard-section')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 style="text-align:center; margin-bottom:20px;">Announcements Calendar</h2>
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div class="modal" id="announcementModal">
    <div class="modal-content">
        <h3 id="modal-title">Add Announcement</h3>
        <input type="text" id="ann-title" placeholder="Title" />
        <textarea id="ann-content" placeholder="Content"></textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="save-btn" onclick="saveAnnouncement()">Save</button>
            <button class="delete-btn" id="deleteBtn" onclick="deleteAnnouncement()" style="display:none;">Delete</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    var currentUserRole = /*[[${user.role.name}]]*/ 'GUEST';
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
    let calendar;
    let selectedDate = null;
    let editingEvent = null;
    let attendanceCalendarInstance;
    let currentUserId;

    // A single, universal function to show and hide sections
    function showSection(sectionId) {
      const sections = ['dashboard-section', 'attendance-user-list-section', 'user-attendance-calendar-section', 'employee-details-section', 'department-details-section', 'hr-details-section', 'announcement-details-section'];

      sections.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = 'none';
        }
      });

      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.style.display = (sectionId === 'dashboard-section') ? 'grid' : 'block';
      }
    }


    // Show loader
    function showLoader() {
      document.getElementById('loader-overlay').classList.remove('hidden');
    }
    // Hide loader
    function hideLoader() {
      document.getElementById('loader-overlay').classList.add('hidden');
    }

    function getSafeUploadLink(path) {
      if (!path) return '';
      let cleanPath = path;

      if (cleanPath.startsWith('/')) {
        cleanPath = cleanPath.substring(1);
      }
      if (cleanPath.startsWith("uploads/")) {
        cleanPath = cleanPath.substring("uploads/".length);
      }

      return `/uploads/${cleanPath}`;
    }

    // New Functions for Attendance
    document.getElementById('attendance-card').addEventListener('click', showAttendanceList);

    function showAttendanceList() {
    showLoader();
    showSection('attendance-user-list-section');

    const tbody = document.querySelector('#attendance-users-table tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';

    fetch('/api/users?excludeRole=ADMIN')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            tbody.innerHTML = ''; // Clear the loading message
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No users found.</td></tr>';
            } else {
                data.forEach(user => {
                    const row = `
                        <tr>
                            <td><a href="#" onclick="showUserAttendance(${user.id}, '${user.name}')">${user.name}</a></td>
                            <td>${user.department || '-'}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error loading users.</td></tr>';
        })
        .finally(() => {
            hideLoader();
        });
}

    function showUserAttendance(userId, userName) {
        showLoader();
        currentUserId = userId;
        showSection('user-attendance-calendar-section');
        document.getElementById('user-attendance-title').innerText = `${userName}'s Attendance Calendar`;
        document.getElementById('attendance-detail-section').style.display = 'none';
        document.getElementById('attendance-calendar-content').style.display = 'block';

        const calendarEl = document.getElementById('userAttendanceCalendar');
        if (attendanceCalendarInstance) {
            attendanceCalendarInstance.destroy();
        }

        attendanceCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            selectable: true,
            headerToolbar: {
                right: 'prev,next today',
                left: 'title'
            },

             events: function(fetchInfo, successCallback, failureCallback) {
                fetch(`/api/attendance/${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        const events = data.map(att => {
                            let color = 'gray'; // Default color for unknown status
                            if (att.status === 'Present') color = 'green';
                            else if (att.status === 'Absent') color = 'red';
                            else if (att.status === 'Leave') color = 'yellow';

                            return {
                                // We don't need the title since we are using background display
                                // title: att.status,
                                start: att.date, // Changed from 'date' to 'start' for consistency with FullCalendar docs
                                display: 'background', // This is the new property
                                backgroundColor: color,
                                borderColor: color,
                                extendedProps: {
                                    checkInTime: att.checkInTime,
                                    checkOutTime: att.checkOutTime,
                                    hoursWorked: att.hoursWorked,
                                    status: att.status
                                }
                            };
                        });
                        successCallback(events);
                        hideLoader();
                    })
                    .catch(error => {
                        console.error('Error fetching attendance:', error);
                        failureCallback(error);
                        hideLoader();
                    });
            },
             dateClick: function(info) {
                fetchDayDetails(currentUserId, info.dateStr);
            },
            eventDidMount: function(info) {
                info.el.style.borderRadius = "8px";
            },
            eventClick: function(info) {
                fetchDayDetails(currentUserId, info.event.startStr);
            }
        });
        attendanceCalendarInstance.render();
    }

    function formatHHMM(timeStr) {
    if (!timeStr) return "-";
    if (timeStr.includes(":") && timeStr.split(':').length >= 2) {
        const parts = timeStr.split(':');
        return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
    }
    return "-";
}
   function fetchDayDetails(userId, dateStr) {
        showLoader();
        fetch(`/api/attendance/${userId}/day/${dateStr}`)
            .then(response => response.json())
            .then(data => {
                const detailSection = document.getElementById('attendance-detail-section');
                const calendarContent = document.getElementById('attendance-calendar-content');

                const dateObj = new Date(dateStr);
                const dayName = dateObj.toLocaleDateString('en-IN', { weekday: 'long' });
                const statusEl = document.getElementById('detail-status');

                document.getElementById('detail-date').innerText = dateObj.toLocaleDateString('en-IN', {day:'numeric', month:'short'});
                document.getElementById('detail-day').innerText = dayName;

                // Check if the day is a weekend (Saturday or Sunday)
                if (dayName === "Saturday" || dayName === "Sunday") {
                    document.getElementById('detail-checkin').innerText = "-";
                    document.getElementById('detail-checkout').innerText = "-";
                    document.getElementById('detail-hours').innerText = "0 Hrs Worked";
                    statusEl.innerText = "Weekend";
                    statusEl.className = "status-pill Weekend";
                } else {
                    // Regular weekday logic
                    function formatHHMM(timeStr) {
                        if (!timeStr) return "-";
                        if (timeStr.includes(":") && timeStr.split(':').length >= 2) {
                            const parts = timeStr.split(':');
                            return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
                        }
                        return "-";
                    }

                    const checkIn = formatHHMM(data.checkInTime);
                    const checkOut = formatHHMM(data.checkOutTime);
                    const hoursWorked = parseFloat(data.hoursWorked) || 0;

                    document.getElementById('detail-checkin').innerText = checkIn;
                    document.getElementById('detail-checkout').innerText = checkOut;

                    const totalMinutes = Math.round(hoursWorked * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;

                    let hoursText = `${hours} Hr${hours !== 1 ? 's' : ''}`;
                    let minutesText = minutes > 0 ? ` ${minutes} Min${minutes !== 1 ? 's' : ''}` : '';

                    document.getElementById('detail-hours').innerText = `${hoursText}${minutesText} Worked`;

                    const status = data.status || "Absent";
                    statusEl.innerText = status;
                    statusEl.className = "status-pill " + status;
                }

                calendarContent.style.display = 'none';
                detailSection.style.display = 'block';
                hideLoader();
            })
            .catch(error => {
                console.error('Error fetching day details:', error);
                hideLoader();
            });
    }

    function hideAttendanceDetails() {
    document.getElementById('attendance-detail-section').style.display = 'none';
    document.getElementById('attendance-calendar-content').style.display = 'block';

    if (attendanceCalendarInstance) {
        attendanceCalendarInstance.render();
    }
  }

    // Existing functions modified to use the new showSection function
    document.getElementById('total-employees-card').addEventListener('click', function(event) {
      event.preventDefault();
      showSection('employee-details-section');
      const tbody = document.querySelector('#employees-table tbody');
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';
      fetch('/employees')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not OK');
          return response.json();
        })
        .then(data => {
          tbody.innerHTML = '';
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No employees found.</td></tr>';
          } else {
            data.forEach(emp => {
              let idProofLink = '-';
              let resumeLink = '-';
              if (currentUserRole === 'ADMIN' || currentUserRole === 'HR') {
                if (emp.idProofPath) {
                  idProofLink = `<a href="${getSafeUploadLink(emp.idProofPath)}" target="_blank" class="doc-link"><i class="fa fa-eye"></i></a>`;
                }
                if (emp.resumePath) {
                  resumeLink = `<a href="${getSafeUploadLink(emp.resumePath)}" target="_blank" title="View Resume" class="doc-link"><i class="fa fa-eye"></i></a>`;
                }
              }
              const row = `
                <tr>
                  <td>${emp.fullName}</td>
                  <td>${emp.email}</td>
                  <td>${emp.phone || '-'}</td>
                  <td>${emp.departmentName || '-'}</td>
                  <td>${emp.authProvider || '-'}</td>
                  <td style="text-align:center;">${idProofLink}</td>
                  <td style="text-align:center;">${resumeLink}</td>
                </tr>`;
              tbody.innerHTML += row;
            });
          }
        })
        .catch(error => {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Error loading employees.</td></tr>`;
          console.error('Fetch error:', error);
          hideLoader();
        });
    });

   // Departments List Card Click
   document.getElementById('total-departments-card').addEventListener('click', function() {
       showSection('department-details-section');
       loadDepartments();
   });

   // Load Departments from API and populate table
   function loadDepartments() {
       const tbody = document.querySelector('#departments-table tbody');
       tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';

       fetch('/api/departments')
           .then(response => response.json())
           .then(data => {
               tbody.innerHTML = '';
               if (data.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No departments found.</td></tr>';
               } else {
                   data.forEach(dep => {
                       const row = `
                           <tr data-id="${dep.id}">
                               <td>${dep.id}</td>
                               <td class="dep-name">${escapeHtml(dep.name)}</td>
                               <td class="dep-desc">${escapeHtml(dep.description || '-')}</td>
                               <td>
                                   <button class="action-btn edit-btn">Edit</button>
                               </td>
                           </tr>`;
                       tbody.innerHTML += row;
                   });

                   document.querySelectorAll('.edit-btn').forEach(btn => {
                       btn.addEventListener('click', onEditClick);
                   });
               }
           })
           .catch(error => {
               tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Error loading departments.</td></tr>`;
               console.error('Fetch error:', error);
               hideLoader();
           });
   }
   function escapeHtml(text) {
       if (!text) return '';
       return text.replace(/[&<>"']/g, function(m) {
           return {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m];
       });
   }
   document.getElementById('department-add-form').addEventListener('submit', function(e) {
       e.preventDefault();
       const nameInput = document.getElementById('dept-name');
       const descInput = document.getElementById('dept-desc');

       const newDepartment = {
           name: nameInput.value.trim(),
           description: descInput.value.trim()
       };
       if (!newDepartment.name || !newDepartment.description) {
           alert('Please enter both Name and Description');
           return;
       }
       fetch('/api/departments', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(newDepartment)
       })
       .then(response => {
           if (!response.ok) throw new Error('Failed to add department');
           return response.json();
       })
       .then(addedDepartment => {
           alert('Department added successfully');
           nameInput.value = '';
           descInput.value = '';
           loadDepartments();
       })
       .catch(error => {
           alert('Error adding department: ' + error.message);
           console.error('Add department error:', error);
       });
   });
   function onEditClick(event) {
       const btn = event.target;
       const row = btn.closest('tr');
       const id = row.getAttribute('data-id');
       const nameTd = row.querySelector('.dep-name');
       const descTd = row.querySelector('.dep-desc');
       const currentName = nameTd.textContent;
       const currentDesc = descTd.textContent === '-' ? '' : descTd.textContent;
       nameTd.innerHTML = `<input type="text" class="edit-input edit-name" value="${escapeHtml(currentName)}">`;
       descTd.innerHTML = `<input type="text" class="edit-input edit-desc" value="${escapeHtml(currentDesc)}">`;
       const actionTd = btn.parentElement;
       actionTd.innerHTML = `
           <button class="action-btn save-btn">Save</button>
           <button class="action-btn cancel-btn">Cancel</button>
       `;
       actionTd.querySelector('.save-btn').addEventListener('click', () => saveEdit(id, row));
       actionTd.querySelector('.cancel-btn').addEventListener('click', () => cancelEdit(row, currentName, currentDesc));
   }
   function saveEdit(id, row) {
       const nameInput = row.querySelector('.edit-name');
       const descInput = row.querySelector('.edit-desc');
       const updatedDepartment = {
           name: nameInput.value.trim(),
           description: descInput.value.trim()
       };
       if (!updatedDepartment.name || !updatedDepartment.description) {
           alert('Please enter both Name and Description');
           return;
       }
       fetch('/api/departments/' + id, {
           method: 'PUT',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(updatedDepartment)
       })
       .then(response => {
           if (!response.ok) throw new Error('Failed to update department');
           return response.json();
       })
       .then(data => {
           alert('Department updated successfully');
           loadDepartments();
       })
       .catch(error => {
           alert('Error updating department: ' + error.message);
           console.error('Update department error:', error);
           hideLoader();
       });
   }
   function cancelEdit(row, originalName, originalDesc) {
       const nameTd = row.querySelector('.dep-name');
       const descTd = row.querySelector('.dep-desc');
       const actionTd = row.querySelector('td:last-child');
       nameTd.textContent = originalName;
       descTd.textContent = originalDesc || '-';
       actionTd.innerHTML = `<button class="action-btn edit-btn">Edit</button>`;
       actionTd.querySelector('.edit-btn').addEventListener('click', onEditClick);
   }

   document.getElementById('total-hrs-card').addEventListener('click', function() {
       showSection('hr-details-section');
       const tbody = document.querySelector('#hr-table tbody');
       tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

       fetch('/hrs')
           .then(res => res.json())
           .then(data => {
               tbody.innerHTML = '';
               if (data.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No HRs found.</td></tr>';
               } else {
                   data.forEach(hr => {
                       let idProofLink = hr.idProofPath ? `<a href="${getSafeUploadLink(hr.idProofPath)}" target="_blank" class="doc-link"><i class="fa fa-eye"></i></a>`  : '-';
                       let resumeLink = hr.resumePath ? `<a href="${getSafeUploadLink(hr.resumePath)}" target="_blank" class="doc-link"><i class="fa fa-eye"></i></a>`  : '-';
                       tbody.innerHTML += `<tr>
                           <td>${hr.name}</td>
                           <td>${hr.email}</td>
                           <td>${hr.phone || '-'}</td>
                           <td>${hr.departmentName || '-'}</td>
                           <td>${hr.roleName || '-'}</td>
                           <td style="text-align:center;">${idProofLink}</td>
                           <td style="text-align:center;">${resumeLink}</td>
                       </tr>`;
                   });
               }
           })
           .catch(err => {
               console.error('Error loading HRs:', err);
               tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Error loading HR list.</td></tr>';
           });
   });

  function loadAnnouncements() {
    showLoader();
    fetch('/announcements')
      .then(res => res.json())
      .then(data => {
        calendar.removeAllEvents();
        data.forEach(a => {
          calendar.addEvent({
            id: a.id,
            title: a.title,
            start: a.createdAt,
            extendedProps: { content: a.content }
          });
        });
        hideLoader();
      })
      .catch(err => { console.error(err); hideLoader(); });
  }

  function openModal(isEdit=false, event=null, dateStr=null) {
    const modal = document.getElementById('announcementModal');
    modal.style.display = 'flex';

    document.getElementById('ann-title').value = isEdit ? event.title : '';
    document.getElementById('ann-content').value = isEdit ? event.extendedProps.content : '';
    document.getElementById('modal-title').innerText = isEdit ? "Edit Announcement" : "Add Announcement";
    document.getElementById('deleteBtn').style.display = isEdit ? "inline-block" : "none";

    if (isEdit) {
      selectedDate = event.startStr;
    } else {
      selectedDate = dateStr;
    }

    editingEvent = event;
  }

  function closeModal() {
    document.getElementById('announcementModal').style.display='none';
    editingEvent = null;
  }

function saveAnnouncement() {
  const title = document.getElementById('ann-title').value.trim();
  const content = document.getElementById('ann-content').value.trim();
  if (!title || !content) {
    alert("Please enter Title & Content");
    return;
  }
  if (!selectedDate) {
    alert("No date selected!");
    return;
  }

  const now = new Date();
  const timeStr = now.toTimeString().split(' ')[0];
  const payload = {
    title,
    content,
    createdAt: selectedDate + "T" + timeStr
  };

  if (editingEvent) {
    fetch('/announcements/'+editingEvent.id, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    }).then(r=>r.json()).then(()=>{
      loadAnnouncements();
      closeModal();
    });
  } else {
    fetch('/announcements', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    }).then(r=>r.json()).then(()=>{
      loadAnnouncements();
      closeModal();
    });
  }
}

  function deleteAnnouncement() {
    if (!editingEvent) return;
    if (!confirm("Delete this announcement?")) return;
    fetch('/announcements/'+editingEvent.id,{method:'DELETE'})
      .then(()=>{ loadAnnouncements(); closeModal(); });
  }

  document.getElementById('total-announcements-card').addEventListener('click', () => {
    showSection('announcement-details-section');

    if (!calendar) {
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView:'dayGridMonth',
        selectable:true,
        dateClick: function(info) {
          if (currentUserRole==='ADMIN' || currentUserRole==='HR') {
            openModal(false, null, info.dateStr);
          }
        },
        eventClick: function(info) {
          if (currentUserRole==='ADMIN' || currentUserRole==='HR') {
            openModal(true, info.event, null);
          } else {
            alert("Title: "+info.event.title+"\nContent: "+info.event.extendedProps.content);
          }
        }
      });
      calendar.render();
    }
    loadAnnouncements();
  });


  window.onclick=function(e){ if(e.target.classList.contains('modal')) closeModal(); };
  window.addEventListener('DOMContentLoaded', hideLoader);
</script>
</body>
</html>