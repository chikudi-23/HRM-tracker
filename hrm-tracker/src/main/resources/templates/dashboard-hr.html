<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>HR Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>
</head>
<body>
<div id="loader-overlay" class="hidden"><div class="spinner"></div></div>

<div class="dashboard-container">
  <div class="sidebar">
    <h2>HR Panel</h2>
    <ul>
      <li><a th:href="@{/dashboard}" class="active">Dashboard</a></li>
      <li><a th:href="@{/profile}">Profile</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="topbar">
      <h1>Welcome, <span th:text="${user.fullName}">HR</span></h1>
      <form id="logoutForm" action="/logout" method="post" style="display:inline;">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="logout-btn">Logout</button>
      </form>
    </div>

    <div class="dashboard-flex">
      <div class="attendance-panel">
        <div class="attendance-profile-box">
          <img th:src="${user.profilePicPath != null} ? @{/uploads/{file}(file=${user.profilePicPath})} : @{/images/default-user.png}"
               alt="">
        </div>

        <h2>Today's Attendance</h2>
        <p><strong>Name:</strong> <span th:text="${user.fullName}">HR Name</span></p>
        <p><strong>Department:</strong> <span th:text="${user.department.name}">Department Name</span></p>
        <div id="timer">00:00:00</div>

        <div style="display:flex; gap:10px;">
          <button id="checkin-btn" class="attendance-btn">Check In</button>
          <button id="checkout-btn" class="attendance-btn" disabled>Check Out</button>
        </div>
      </div>

      <div class="cards-container" id="dashboard-section">
        <div class="card" id="total-employees-card"><h2>Employees</h2></div>
        <div class="card"><h2>Leaves</h2></div>
        <div class="card" id="attendance-calendar-card"><h2>Attendance</h2></div>
        <div class="card" id="total-announcements-card"><h2>Announcements</h2></div>
      </div>
    </div>

    <div id="employee-details-section">
      <button class="back-btn" onclick="hideEmployeeDetails()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h2>Employees List</h2>
      <table id="employees-table">
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Department</th><th>Auth Provider</th><th>ID Proof</th><th>Resume</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="announcement-details-section">
      <button class="back-btn" onclick="backToDashboard()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h2 style="text-align:center; margin-bottom:20px;">Announcements Calendar</h2>
      <div id="calendar"></div>
    </div>

    <div id="attendance-calendar-section">
      <button class="back-btn" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i></button>
      <h2>My Attendance Calendar</h2>

      <div id="attendance-calendar-content">
        <div id="attendanceCalendar"></div>
        <div class="legend">
          <div class="legend-item"><span class="legend-color" style="background: green;"></span> Present</div>
          <div class="legend-item"><span class="legend-color" style="background: red;"></span> Absent</div>
          <div class="legend-item"><span class="legend-color" style="background: yellow;"></span> Leave</div>
        </div>
      </div>

      <div id="no-attendance-data-message" class="no-data-message" style="display: none;">
        No attendance data found for this period.
      </div>

      <div id="attendance-detail-section">
        <button class="back-btn" onclick="hideAttendanceDetails()"><i class="fas fa-arrow-left"></i></button>
        <h3 id="attendance-detail-title">Attendance Details</h3>

        <div class="horizontal-attendance">
          <div class="date-column">
            <div id="detail-date" class="date-text">--</div>
            <div id="detail-day" class="day-text">--</div>
          </div>

          <div class="timeline-bar">
            <div class="start-time" id="detail-checkin">--</div>
            <div class="end-time" id="detail-checkout">--</div>
          </div>

          <div class="worked-hours">
            <span id="detail-hours">0</span>
          </div>
        </div>

        <div class="attendance-status">
          Status: <span id="detail-status" class="status-pill">--</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="announcementModal">
  <div class="modal-content">
    <h3 id="modal-title">Add Announcement</h3>
    <input type="text" id="ann-title" placeholder="Title" />
    <textarea id="ann-content" placeholder="Content"></textarea>
    <div style="margin-top:10px; text-align:right;">
      <button class="save-btn" onclick="saveAnnouncement()">Save</button>
      <button class="delete-btn" id="deleteBtn" onclick="deleteAnnouncement()" style="display:none;">Delete</button>
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  var currentUserRole = /*[[${user.role.name}]]*/ 'GUEST';
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
  let calendar;
  let selectedDate = null;
  let editingEvent = null;

  function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
  function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

  function getSafeUploadLink(path) {
    if (!path) return '';
    let cleanPath = path;
    if (cleanPath.startsWith('/')) cleanPath = cleanPath.substring(1);
    if (cleanPath.startsWith("uploads/")) cleanPath = cleanPath.substring("uploads/".length);
    return `/uploads/${cleanPath}`;
  }

  // ---------------- Employees Section ----------------
  document.getElementById('total-employees-card').addEventListener('click', function(event) {
    event.preventDefault();
    showLoader();
    const tbody = document.querySelector('#employees-table tbody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

    fetch('/employees')
      .then(response => response.json())
      .then(data => {
        tbody.innerHTML = '';
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No employees found.</td></tr>';
        } else {
          data.forEach(emp => {
            let idProofLink = '-', resumeLink = '-';
            if (currentUserRole === 'ADMIN' || currentUserRole === 'HR') {
              if (emp.idProofPath) idProofLink = `<a href="${getSafeUploadLink(emp.idProofPath)}" target="_blank"><i class="fa fa-eye"></i></a>`;
              if (emp.resumePath) resumeLink = `<a href="${getSafeUploadLink(emp.resumePath)}" target="_blank"><i class="fa fa-eye"></i></a>`;
            }
            tbody.innerHTML += `
              <tr>
                <td>${emp.name}</td>
                <td>${emp.email}</td>
                <td>${emp.phone || '-'}</td>
                <td>${emp.departmentName || '-'}</td>
                <td>${emp.authProvider || '-'}</td>
                <td style="text-align:center;">${idProofLink}</td>
                <td style="text-align:center;">${resumeLink}</td>
              </tr>`;
          });
        }
        document.getElementById('employee-details-section').style.display = 'block';
        document.querySelector('.attendance-panel').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'none';
        hideLoader();
      })
      .catch(err => { console.error(err); hideLoader(); });
  });

  function hideEmployeeDetails() {
    document.getElementById('employee-details-section').style.display = 'none';
    document.querySelector('.attendance-panel').style.display = 'flex';
    document.getElementById('dashboard-section').style.display = 'grid';
  }

  // ---------------- Announcements ----------------
  function loadAnnouncements() {
    showLoader();
    fetch('/announcements')
      .then(res => res.json())
      .then(data => {
        calendar.removeAllEvents();
        data.forEach(a => {
          calendar.addEvent({ id:a.id, title:a.title, start:a.createdAt, extendedProps:{content:a.content} });
        });
        hideLoader();
      }).catch(err => { console.error(err); hideLoader(); });
  }

  function openModal(isEdit=false, event=null, dateStr=null) {
    const modal = document.getElementById('announcementModal');
    modal.style.display = 'flex';
    document.getElementById('ann-title').value = isEdit ? event.title : '';
    document.getElementById('ann-content').value = isEdit ? event.extendedProps.content : '';
    document.getElementById('modal-title').innerText = isEdit ? "Edit Announcement" : "Add Announcement";
    document.getElementById('deleteBtn').style.display = isEdit ? "inline-block" : "none";
    selectedDate = isEdit ? event.startStr : dateStr;
    editingEvent = event;
  }

  function closeModal() { document.getElementById('announcementModal').style.display='none'; editingEvent=null; }

  function saveAnnouncement() {
    const title=document.getElementById('ann-title').value.trim();
    const content=document.getElementById('ann-content').value.trim();
    if(!title||!content){alert("Please enter Title & Content");return;}
    if(!selectedDate){alert("No date selected!");return;}
    const now=new Date();
    const timeStr=now.toTimeString().split(' ')[0];
    const payload={title,content,createdAt:selectedDate+"T"+timeStr};
    if(editingEvent){
      fetch('/announcements/'+editingEvent.id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(()=>{loadAnnouncements();closeModal();});
    }else{
      fetch('/announcements',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(()=>{loadAnnouncements();closeModal();});
    }
  }

  function deleteAnnouncement() {
    if(!editingEvent) return;
    if(!confirm("Delete this announcement?")) return;
    fetch('/announcements/'+editingEvent.id,{method:'DELETE'}).then(()=>{loadAnnouncements();closeModal();});
  }

  document.getElementById('total-announcements-card').addEventListener('click', () => {
    document.getElementById('dashboard-section').style.display='none';
    document.querySelector('.attendance-panel').style.display = 'none';
    document.getElementById('announcement-details-section').style.display='block';
    if (!calendar) {
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView:'dayGridMonth',
        selectable:true,
        dateClick: function(info){ if(currentUserRole==='ADMIN'||currentUserRole==='HR'){openModal(false,null,info.dateStr);} },
        eventClick: function(info){
          if(currentUserRole==='ADMIN'||currentUserRole==='HR'){openModal(true,info.event,null);}
          else{ alert("Title: "+info.event.title+"\nContent: "+info.event.extendedProps.content); }
        }
      });
      calendar.render();
    }
    loadAnnouncements();
  });

  // ✅ FIXED backToDashboard: hides both announcement & attendance sections
  function backToDashboard() {
    document.getElementById('announcement-details-section').style.display = 'none';
    document.getElementById('attendance-calendar-section').style.display = 'none';
    document.querySelector('.attendance-panel').style.display = 'flex';
    document.getElementById('dashboard-section').style.display = 'grid';

    // ✅ Clear attendanceGraph (avoid sticking below dashboard)
    let graphContainer = document.getElementById('attendanceGraph');
    if (graphContainer) graphContainer.innerHTML = "";
  }

  window.onclick=function(e){ if(e.target.classList.contains('modal')) closeModal(); };

  // ---------------- Attendance Timer + Buttons ----------------
   let checkinTime = null, timerInterval = null;
  const checkinBtn = document.getElementById('checkin-btn');
  const checkoutBtn = document.getElementById('checkout-btn');
  const timerDisplay = document.getElementById('timer');

  function formatTime(seconds) {
    const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${secs}`;
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - checkinTime) / 1000);
      timerDisplay.textContent = formatTime(diff);
      if (diff === 8 * 3600) alert("8 hours complete! You can check out now.");
    }, 1000);
  }

  // Restore checkin from localStorage
  window.addEventListener("load", () => {
    const storedCheckin = localStorage.getItem("checkinTime");
    const checkedOut = localStorage.getItem("checkedOut");

    if (storedCheckin && !checkedOut) {
      checkinTime = new Date(storedCheckin);
      checkinBtn.disabled = true;
      checkoutBtn.disabled = false;
      startTimer();
    } else {
      timerDisplay.textContent = "00:00:00";
      checkinBtn.disabled = false;
      checkoutBtn.disabled = true;
    }
  });

  checkinBtn.addEventListener('click', () => {
    checkinTime = new Date();
    localStorage.setItem("checkinTime", checkinTime.toISOString());
    localStorage.removeItem("checkedOut"); // Ensure checkedOut is removed on check-in

    checkinBtn.disabled = true;
    checkoutBtn.disabled = false;
    startTimer();

    fetch('/attendance/checkin', { method: 'POST' }).catch(err => console.error(err));
  });

  checkoutBtn.addEventListener('click', () => {
    clearInterval(timerInterval);
    const workedSeconds = Math.floor((new Date() - checkinTime) / 1000);
    timerDisplay.textContent = formatTime(workedSeconds);

    checkoutBtn.disabled = true;
    localStorage.setItem("checkedOut", "true"); // Mark as checked out

    fetch('/attendance/checkout', { method: 'POST' }).catch(err => console.error(err));
  });

  function scheduleMidnightReset() {
    const now = new Date();
    const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
    const msUntilMidnight = midnight.getTime() - now.getTime();

    setTimeout(() => {
      timerDisplay.textContent = "00:00:00";
      checkinBtn.disabled = false;
      checkoutBtn.disabled = true;
      checkinTime = null;
      clearInterval(timerInterval); // Clear interval to prevent multiple timers
      timerInterval = null;
      localStorage.removeItem("checkinTime");
      localStorage.removeItem("checkedOut");
      scheduleMidnightReset(); // Reschedule for the next midnight
    }, msUntilMidnight);
  }
  scheduleMidnightReset();

  let attendanceCalendarInstance = null;

  // This function navigates from the attendance details back to the attendance calendar.
  function hideAttendanceDetails() {
    document.getElementById('attendance-detail-section').style.display = 'none';
    document.getElementById('attendance-calendar-content').style.display = 'block';

    if (attendanceCalendarInstance) {
        attendanceCalendarInstance.render();
    }
  }

  // Attendance Calendar card click
  document.getElementById('attendance-calendar-card').addEventListener('click', function(event) {
    event.preventDefault();
    showLoader();

    fetch('/attendance/calendar')
      .then(res => res.json())
      .then(data => {
        // Hide the dashboard sections and show the attendance calendar section
        document.querySelector('.attendance-panel').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('attendance-calendar-section').style.display = 'block';

        // Hide the details section in case it was open
        document.getElementById('attendance-detail-section').style.display = 'none';

        // Check if data is empty or not an array
        if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('attendance-calendar-content').style.display = 'none';
            document.getElementById('no-attendance-data-message').style.display = 'block';
        } else {
            document.getElementById('attendance-calendar-content').style.display = 'block';
            document.getElementById('no-attendance-data-message').style.display = 'none';

            let calendarEl = document.getElementById('attendanceCalendar');
            if(attendanceCalendarInstance) {
                attendanceCalendarInstance.destroy();
                attendanceCalendarInstance = null;
            }

             const today = new Date().toISOString().slice(0, 10);
            let todayStatus = null;
            let todayData = null;

            // Find today's attendance data if it exists
            data.forEach(a => {
              if (a.date === today) {
                todayStatus = a.status;
                todayData = a;
              }
            });

            // If no data for today, and it's not a weekend, set status to Absent
            const dayOfWeek = new Date().getDay(); // Sunday is 0, Saturday is 6
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

            if (!todayStatus && !isWeekend) {
              data.push({
                date: today,
                status: "Absent",
                checkInTime: null,
                checkOutTime: null,
                hoursWorked: 0
              });
            }


            attendanceCalendarInstance = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              selectable: true,
              events: data.map(a => ({
                start: a.date,
                display: 'background',
                backgroundColor: a.status === "Present" ? "green" :
                                 (a.status === "Absent" || !a.status) ? "red" : "yellow"
              })),
              eventDidMount: function(info) {
                info.el.style.borderRadius = "8px";
              },
              dateClick: function(info) {
                const selectedDate = info.dateStr;
                showLoader();

                fetch(`/api/attendance/day/${selectedDate}`)
                  .then(res => res.json())
                  .then(data => {
                    document.getElementById('attendance-calendar-content').style.display = 'none';
                    document.getElementById('attendance-detail-section').style.display = 'block';

                    const dateObj = new Date(selectedDate);
                    const formattedDate = dateObj.toLocaleDateString('en-IN', { day:'numeric', month:'short'});
                    const dayName = dateObj.toLocaleDateString('en-IN', { weekday: 'long' });

                    document.getElementById('detail-date').innerText = formattedDate;
                    document.getElementById('detail-day').innerText = dayName;
                    const statusEl = document.getElementById('detail-status');

                    if (dayName === "Saturday" || dayName === "Sunday") {
                      statusEl.innerText = "Weekend";
                      statusEl.className = "status-pill Weekend";
                      document.getElementById('detail-checkin').innerText = "-";
                      document.getElementById('detail-checkout').innerText = "-";
                      document.getElementById('detail-hours').innerText = "0 Hrs Worked";
                    } else {
                      function formatHHMM(timeStr) {
                        if (!timeStr) return "-";
                        if (timeStr.includes(":")) {
                          const parts = timeStr.split(":");
                          return parts[0].padStart(2,"0") + ":" + parts[1].padStart(2,"0");
                        }
                        const d = new Date(timeStr);
                        if (!isNaN(d)) return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
                        return "-";
                      }

                      const checkIn = formatHHMM(data.checkInTime);
                      const checkOut = formatHHMM(data.checkOutTime);
                      const hoursWorked = parseFloat(data.hoursWorked) || 0;

                      document.getElementById('detail-checkin').innerText = checkIn;
                      document.getElementById('detail-checkout').innerText = checkOut;

                       const totalMinutes = Math.round(hoursWorked * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            let hoursText = `${hours} Hr${hours !== 1 ? 's' : ''}`;
            let minutesText = minutes > 0 ? ` ${minutes} Min${minutes !== 1 ? 's' : ''}` : '';

            document.getElementById('detail-hours').innerText = `${hoursText}${minutesText} Worked`;

                      const status = data.status || "Absent";
                      statusEl.innerText = status;
                      statusEl.className = "status-pill " + status;
                    }
                    hideLoader();
                  })
                  .catch(err => {
                    console.error("Error fetching attendance data", err);
                    hideLoader();
                  });
              }
            });
            attendanceCalendarInstance.render();
        }
        hideLoader();
      })
      .catch(err => { alert("Error loading attendance."); console.error(err); hideLoader(); });
  });

  window.addEventListener('DOMContentLoaded',hideLoader);
</script>

</body>
</html>